<div class="text-center space-y-6 max-w-3xl mx-auto mb-20">
    <div class="inline-flex items-center px-3 py-1 rounded-full border border-brand-purple/30 bg-brand-purple/10 text-brand-purple text-xs font-medium mb-2">
        <span class="flex h-2 w-2 rounded-full bg-brand-purple mr-2"></span>
        Nouveau challenge disponible
    </div>
    <h1 class="text-5xl sm:text-6xl font-bold text-white tracking-tight leading-tight">
        Construisez votre portfolio <br />
        <span class="text-gradient">Une semaine à la fois.</span>
    </h1>
    <p class="text-xl text-gray-400 max-w-2xl mx-auto">
        Du dimanche au samedi, un nouveau projet fun ou réaliste à coder. Stack libre. Feedback communautaire. Progressez en pratiquant.
    </p>
    <div class="pt-4 flex justify-center gap-4">
        <a href="#active-challenge" class="px-8 py-3 rounded-lg bg-white text-brand-dark font-bold hover:bg-gray-100 transition shadow-[0_0_20px_rgba(255,255,255,0.3)]">
            Voir le défi actuel
        </a>
        <a href="#archive" class="px-8 py-3 rounded-lg border border-white/10 text-white hover:bg-white/5 transition">
            Explorer les archives
        </a>
    </div>

    <!-- Social Proof -->
    <div id="social-proof" class="pt-6 flex items-center justify-center gap-3 opacity-0 transition-opacity duration-500">
        <div id="avatars-stack" class="flex -space-x-2">
            <!-- Avatars will be injected here -->
        </div>
        <p class="text-sm text-gray-400">
            Déjà <strong id="solutions-count" class="text-white">--</strong> solutions proposées par la communauté
        </p>
    </div>
</div>

<script>
    // Cache configuration
    const CACHE_KEY = 'gh_cache_social_proof';
    const CACHE_DURATION = 60 * 1000; // 1 minute

    interface CacheEntry {
        data: any[];
        timestamp: number;
    }

    function getFromCache(): any[] | null {
        try {
            const cached = sessionStorage.getItem(CACHE_KEY);
            if (!cached) return null;
            
            const entry: CacheEntry = JSON.parse(cached);
            if (Date.now() - entry.timestamp > CACHE_DURATION) {
                sessionStorage.removeItem(CACHE_KEY);
                return null;
            }
            console.log('[Cache] Using cached social proof data');
            return entry.data;
        } catch {
            return null;
        }
    }

    function setInCache(data: any[]): void {
        try {
            const entry: CacheEntry = { data, timestamp: Date.now() };
            sessionStorage.setItem(CACHE_KEY, JSON.stringify(entry));
            console.log('[Cache] Stored social proof data');
        } catch {
            // sessionStorage might be full or disabled
        }
    }

    async function loadSocialProof() {
        try {
            // Check cache first
            let issues = getFromCache();
            
            if (!issues) {
                // Fetch all issues from the repo to count total solutions
                const response = await fetch('https://api.github.com/search/issues?q=repo:yoanbernabeu/DevChallenges+is:issue&per_page=100');
                if (!response.ok) return;
                
                const data = await response.json();
                issues = data.items || [];
                
                // Store in cache
                if (issues.length > 0) {
                    setInCache(issues);
                }
            }
            
            if (issues.length === 0) return;

            // Get unique users
            const uniqueUsers = new Map();
            issues.forEach((issue: any) => {
                if (!uniqueUsers.has(issue.user.login)) {
                    uniqueUsers.set(issue.user.login, issue.user.avatar_url);
                }
            });

            // Display avatars (max 5)
            const avatarsStack = document.getElementById('avatars-stack');
            const avatars = Array.from(uniqueUsers.entries()).slice(0, 5);
            
            if (avatarsStack) {
                avatarsStack.innerHTML = avatars.map(([username, avatarUrl]) => `
                    <img 
                        src="${avatarUrl}" 
                        alt="${username}"
                        class="w-8 h-8 rounded-full border-2 border-brand-dark"
                        loading="lazy"
                    />
                `).join('');
            }

            // Update count
            const countEl = document.getElementById('solutions-count');
            if (countEl) countEl.textContent = issues.length.toString();

            // Show the section
            const socialProof = document.getElementById('social-proof');
            if (socialProof) socialProof.classList.remove('opacity-0');

        } catch (error) {
            console.error('Failed to load social proof:', error);
        }
    }

    loadSocialProof();
</script>
