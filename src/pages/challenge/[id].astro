---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import SubmissionModal from '../../components/SubmissionModal.astro';
import challenges from '../../data/challenges.json';

export function getStaticPaths() {
    const isDev = import.meta.env.DEV;
    const now = new Date();
    
    // Filter challenges: in production, only show active and archived
    const filteredChallenges = challenges.filter(challenge => {
        if (isDev) return true; // Show all in dev
        
        const startDate = new Date(challenge.startDate.replace('Z', ''));
        return now >= startDate; // Only show if started
    });

    return filteredChallenges.map(challenge => ({
        params: { id: challenge.id },
        props: { challenge }
    }));
}

const { challenge } = Astro.props;

// Compute challenge status and dates
const now = new Date();
const startDate = new Date(challenge.startDate.replace('Z', ''));
const endDate = new Date(startDate);
endDate.setDate(endDate.getDate() + 6);
endDate.setHours(23, 59, 59, 999);

type ChallengeStatus = 'upcoming' | 'active' | 'archived';
let status: ChallengeStatus;
if (now < startDate) {
    status = 'upcoming';
} else if (now >= startDate && now <= endDate) {
    status = 'active';
} else {
    status = 'archived';
}

// Check if we're in dev mode
const isDev = import.meta.env.DEV;

// Format dates for display
const formattedStartDate = new Intl.DateTimeFormat('fr-FR', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
}).format(startDate);

const formattedEndDate = new Intl.DateTimeFormat('fr-FR', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    hour: 'numeric',
    minute: 'numeric'
}).format(endDate);

// Difficulty colors
const difficultyColors = {
    Easy: 'bg-green-500/10 text-green-400 border-green-500/20',
    Medium: 'bg-blue-500/10 text-blue-400 border-blue-500/20',
    Hard: 'bg-orange-500/10 text-orange-400 border-orange-500/20'
};

// Status labels and colors
const statusConfig = {
    upcoming: {
        label: '√Ä venir',
        color: 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20',
        icon: 'fa-clock'
    },
    active: {
        label: 'En cours',
        color: 'bg-red-500/10 text-red-400 border-red-500/20',
        icon: 'fa-bolt'
    },
    archived: {
        label: 'Termin√©',
        color: 'bg-gray-500/10 text-gray-400 border-gray-500/20',
        icon: 'fa-check'
    }
};

const currentStatus = statusConfig[status];

// Pass data to client
const challengeData = JSON.stringify({
    ...challenge,
    endDate: endDate.toISOString(),
    status
});
---

<Layout title={`${challenge.title} - DevChallenges`}>
    <Navbar />

    <main class="grow pt-32 pb-12 px-4 sm:px-6 lg:px-8 max-w-5xl mx-auto w-full">
        
        <!-- Back Link -->
        <a href="/" class="inline-flex items-center gap-2 text-gray-400 hover:text-white transition mb-8 group">
            <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
            Retour aux challenges
        </a>

        <!-- Upcoming Warning (only in dev) -->
        {status === 'upcoming' && isDev && (
            <div class="mb-6 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30 flex items-center gap-3">
                <i class="fa-solid fa-eye-slash text-yellow-400"></i>
                <p class="text-yellow-300 text-sm">
                    <strong>Mode d√©veloppement :</strong> Ce d√©fi n'est pas encore visible en production.
                </p>
            </div>
        )}

        <!-- Challenge Header -->
        <div id="challenge-page" class="relative mb-12" data-challenge={challengeData}>
            <div class="absolute -inset-1 bg-linear-to-r from-brand-purple to-brand-pink rounded-2xl blur opacity-20"></div>
            
            <div class="relative glass-panel rounded-xl overflow-hidden">
                <div class="p-8 border-b border-white/5">
                    <!-- Status & Tag -->
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <span class={`text-xs px-3 py-1 rounded-full border font-medium flex items-center gap-2 ${currentStatus.color}`}>
                            <i class={`fa-solid ${currentStatus.icon}`}></i>
                            {currentStatus.label}
                        </span>
                        <span class="text-gray-500 text-sm font-mono">#{challenge.tag}</span>
                        <span class={`text-xs px-2 py-0.5 rounded border ${difficultyColors[challenge.difficulty as keyof typeof difficultyColors]}`}>
                            {challenge.difficulty}
                        </span>
                    </div>

                    <!-- Title & Description -->
                    <h1 class="text-4xl font-bold text-white mb-4">{challenge.title}</h1>
                    <p class="text-gray-400 text-lg max-w-2xl">{challenge.description}</p>

                    <!-- Dates -->
                    <div class="mt-6 flex flex-wrap gap-6 text-sm">
                        <div class="flex items-center gap-2 text-gray-400">
                            <i class="fa-regular fa-calendar text-brand-purple"></i>
                            <span>D√©but: <span class="text-white capitalize">{formattedStartDate}</span></span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-400">
                            <i class="fa-regular fa-calendar-check text-brand-pink"></i>
                            <span>Fin: <span class="text-white capitalize">{formattedEndDate}</span></span>
                        </div>
                    </div>

                    <!-- Timer for active challenge -->
                    {status === 'active' && (
                        <div class="mt-6 inline-block bg-brand-surface rounded-lg p-4 border border-white/5">
                            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Temps restant</p>
                            <div id="timer-val" class="text-2xl font-mono font-bold text-white">--j --h --m --s</div>
                        </div>
                    )}

                    <!-- Countdown for upcoming challenge -->
                    {status === 'upcoming' && (
                        <div class="mt-6 inline-block bg-yellow-500/5 rounded-lg p-4 border border-yellow-500/20">
                            <p class="text-xs text-yellow-400 uppercase tracking-wider mb-1">Commence dans</p>
                            <div id="countdown-val" class="text-2xl font-mono font-bold text-yellow-300">--j --h --m --s</div>
                        </div>
                    )}
                </div>

                <!-- Brief Section -->
                <div class="p-8">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-scroll text-brand-purple"></i>
                        Le Brief
                    </h2>
                    <div class="prose prose-invert prose-sm max-w-none text-gray-400 bg-brand-surface/50 rounded-lg p-6 border border-white/5">
                        <p set:html={challenge.brief}></p>
                    </div>

                    <!-- Specs Link if available -->
                    {challenge.specsUrl && (
                        <a 
                            href={challenge.specsUrl}
                            target="_blank"
                            class="mt-6 inline-flex items-center gap-3 px-5 py-3 rounded-lg bg-linear-to-r from-brand-purple/20 to-brand-pink/20 border border-brand-purple/30 hover:border-brand-purple/50 transition group"
                        >
                            <i class="fa-solid fa-book text-brand-purple"></i>
                            <div>
                                <p class="text-white font-medium text-sm">üìñ Sp√©cifications compl√®tes</p>
                                <p class="text-gray-400 text-xs">Consultez le repo avec toutes les specs d√©taill√©es</p>
                            </div>
                            <i class="fa-solid fa-external-link-alt text-gray-500 group-hover:text-brand-purple transition ml-auto"></i>
                        </a>
                    )}

                    <!-- CTA for active challenge -->
                    {status === 'active' && (
                        <div class="mt-8 bg-brand-surface/50 rounded-xl p-6 border border-dashed border-white/10 flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div>
                                <h4 class="text-white font-bold text-sm">Pr√™t √† coder ?</h4>
                                <p class="text-xs text-gray-500">Soumettez votre repo via Pull Request.</p>
                            </div>
                            <button id="open-modal-btn" class="w-full sm:w-auto px-6 py-2.5 bg-brand-purple hover:bg-brand-purple/90 text-white rounded-lg font-medium transition flex items-center justify-center gap-2 text-sm shadow-[0_0_15px_rgba(124,58,237,0.4)]">
                                <i class="fa-brands fa-github"></i>
                                Proposer ma solution
                            </button>
                        </div>
                    )}
                </div>
            </div>
        </div>

        <!-- Participants Section (for active and archived) -->
        {(status === 'active' || status === 'archived') && (
            <div class="glass-panel rounded-xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-users text-brand-pink"></i>
                        Solutions propos√©es
                    </h2>
                    <span id="participant-count" class="text-sm text-brand-purple font-mono">-- participants</span>
                </div>

                <div id="participants-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Loading State -->
                    <div class="animate-pulse col-span-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {[1, 2, 3].map(() => (
                            <div class="flex items-center gap-3 p-4 rounded-lg bg-white/5 border border-white/5">
                                <div class="w-10 h-10 rounded-full bg-white/10"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-4 bg-white/10 rounded w-1/2"></div>
                                    <div class="h-3 bg-white/5 rounded w-1/3"></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        )}

        <!-- Share Section -->
        <div class="mt-8 text-center">
            <p class="text-gray-500 text-sm mb-3">Partagez ce d√©fi</p>
            <div class="flex justify-center gap-3">
                <button 
                    id="copy-link-btn"
                    class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition text-sm flex items-center gap-2"
                >
                    <i class="fa-solid fa-link"></i>
                    Copier le lien
                </button>
                <a 
                    href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(`üöÄ D√©couvrez le challenge "${challenge.title}" sur DevChallenges !`)}&url=${encodeURIComponent(`https://devchallenges.yoandev.co/challenge/${challenge.id}`)}`}
                    target="_blank"
                    class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition text-sm flex items-center gap-2"
                >
                    <i class="fa-brands fa-x-twitter"></i>
                    Twitter
                </a>
            </div>
            <p id="copy-feedback" class="text-green-400 text-xs mt-2 opacity-0 transition-opacity">Lien copi√© !</p>
        </div>

    </main>

    <Footer />
    <SubmissionModal />
</Layout>

<script>
    import { getParticipants } from '../../utils/github';

    const container = document.getElementById('challenge-page');
    const challengeData = container?.dataset.challenge ? JSON.parse(container.dataset.challenge) : null;

    if (challengeData) {
        const { tag, title, endDate, startDate, status } = challengeData;

        // Timer Logic for active challenges
        if (status === 'active') {
            function updateTimer() {
                const deadline = new Date(endDate);
                const now = new Date().getTime();
                const distance = deadline.getTime() - now;

                const timerVal = document.getElementById('timer-val');
                if (!timerVal) return;

                if (distance < 0) {
                    timerVal.innerText = "Termin√©";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerVal.innerText = `${days}j ${hours}h ${minutes}m ${seconds}s`;
            }

            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // Countdown for upcoming challenges
        if (status === 'upcoming') {
            function updateCountdown() {
                const start = new Date(challengeData.startDate.replace('Z', ''));
                const now = new Date().getTime();
                const distance = start.getTime() - now;

                const countdownVal = document.getElementById('countdown-val');
                if (!countdownVal) return;

                if (distance < 0) {
                    countdownVal.innerText = "C'est parti !";
                    // Reload page to update status
                    setTimeout(() => window.location.reload(), 1000);
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownVal.innerText = `${days}j ${hours}h ${minutes}m ${seconds}s`;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // Load participants for active/archived
        if (status === 'active' || status === 'archived') {
            async function loadParticipants() {
                try {
                    const participants = await getParticipants(tag);
                    
                    const countEl = document.getElementById('participant-count');
                    if (countEl) countEl.innerText = `${participants.length} participant${participants.length > 1 ? 's' : ''}`;

                    const grid = document.getElementById('participants-grid');
                    if (grid) {
                        if (participants.length === 0) {
                            grid.innerHTML = `
                                <div class="col-span-full text-center py-8">
                                    <p class="text-gray-400 text-sm mb-2">Aucune participation pour le moment.</p>
                                    ${status === 'active' ? `<button id="be-first-btn" class="text-brand-purple font-bold text-sm hover:underline cursor-pointer">Soyez le/la premier(e) ! üöÄ</button>` : ''}
                                </div>
                            `;
                            
                            const beFirstBtn = document.getElementById('be-first-btn');
                            if (beFirstBtn) {
                                beFirstBtn.addEventListener('click', () => {
                                    document.dispatchEvent(new CustomEvent('open-submission-modal', { detail: { tag, title } }));
                                });
                            }
                        } else {
                            grid.innerHTML = participants.map(p => `
                                <a href="${p.url}" target="_blank" class="flex items-center gap-3 p-4 rounded-lg bg-white/5 hover:bg-white/10 transition border border-white/5 hover:border-brand-purple/30 group">
                                    <img src="${p.avatarUrl}" loading="lazy" class="w-10 h-10 rounded-full border border-white/10" alt="${p.username}" />
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-white truncate group-hover:text-brand-purple transition">${p.username}</p>
                                        <p class="text-xs text-gray-500">Voir la solution</p>
                                    </div>
                                    <i class="fa-brands fa-github text-gray-500 group-hover:text-white transition"></i>
                                </a>
                            `).join('');
                        }
                    }
                } catch (error) {
                    console.error('Failed to load participants', error);
                    const grid = document.getElementById('participants-grid');
                    if (grid) grid.innerHTML = '<p class="col-span-full text-red-400 text-sm text-center">Erreur de chargement</p>';
                }
            }

            loadParticipants();
        }

        // Modal for submission
        const openBtn = document.getElementById('open-modal-btn');
        if (openBtn) {
            openBtn.addEventListener('click', () => {
                document.dispatchEvent(new CustomEvent('open-submission-modal', { detail: { tag, title } }));
            });
        }
    }

    // Copy link button
    const copyBtn = document.getElementById('copy-link-btn');
    const feedback = document.getElementById('copy-feedback');
    
    if (copyBtn && feedback) {
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(window.location.href);
                feedback.classList.remove('opacity-0');
                setTimeout(() => feedback.classList.add('opacity-0'), 2000);
            } catch (err) {
                console.error('Failed to copy', err);
            }
        });
    }
</script>

